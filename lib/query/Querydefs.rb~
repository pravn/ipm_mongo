$LOAD_PATH << '.'
class Query_operations 

#  include Mongo_ops

  def self.return_attr(attrib, imb_attr,query)
    h=Array.new

    attrib=attrib.split('.')[1]
    count=0
    @coll.find(query).each do
      |x|
      h.push(x["base"][imb_attr]["%imb"]=>x["banner"][attrib])
#      puts "h=", h.inspect
    end
    return h
  end

  def self.return_imb_correlation_attr(attrib,query)
    h=Array.new

    @coll.find(query).each do
      |x|
      h.push(x["base"]["wallclock"]["%imb"]=>x["base"][attrib]["%imb"])
    end
    return h
  end

  def self.return_cputime_comm(query)
    h=Array.new
    
    @coll.find(query).each do
      |x|
      h.push(x["base"]["wallclock"]["total"].to_i=>x["banner"]["%comm"].to_i)
    end
    return h
  end

  def self.return_concurrency_comm(query)
    h=Array.new
    @coll.find(query).each do
      |x|
      h.push(x["banner"]["tasks"]=>x["banner"]["%comm"])
    end
    return h
  end

  def self.return_cputime_concurrency(query)
    h=Array.new
    @coll.find(query).each do
      |x|
      h.push(x["base"]["wallclock"]["total"]=>x["banner"]["tasks"])
    end
    return h
  end

  def self.return_allreduce_attr(query)
    h = Array.new 
    
     Mongo_ops.find(query).each do 
      |x|
      if (x["base"]["comm"]["%imb"] >20.0)
        if defined? (x["base"]["functions"]["MPI_Allreduce"]["total"]/(x["banner"]["wallclock"]*x["banner"]["%comm"])>0.2)
            x1=Hash.new
            x1["commimb"]=x["base"]["comm"]["%imb"].to_i
            x1["allred_imb"]=x["base"]["functions"]["MPI_Allreduce"]["%imb"].to_i
            x1["concurrency"]=x["banner"]["tasks"].to_i
            x1["wallclock"]=x["banner"]["wallclock"].to_i
            h.push(x1)
        end
      end
    end
    return h
  end

  def self.return_alltoall_attr(query)
	  h = Array.new 

	  Mongo_ops.find(query).each do 
		  |x|
		  if (x["base"]["comm"]["%imb"] >20.0)
			  if defined? (x["base"]["functions"]["MPI_Alltoall"]["total"]/(x["banner"]["wallclock"]*x["banner"]["%comm"])>0.2)
				  x1=Hash.new
				  x1["commimb"]=x["base"]["comm"]["%imb"].to_i
				  x1["alltoall_imb"]=x["base"]["functions"]["MPI_Alltoall"]["%imb"].to_i
				  x1["concurrency"]=x["banner"]["tasks"].to_i
				  x1["wallclock"]=x["banner"]["wallclock"].to_i
				  h.push(x1)
			  end
		  end
	  end
	  return h
  end

end  #end of class 
